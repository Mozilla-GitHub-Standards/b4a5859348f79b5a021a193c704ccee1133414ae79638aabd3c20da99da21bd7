
var loader=Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);loader.loadSubScript("chrome://ytoolbar/content/logger.js");loader.loadSubScript("chrome://ytoolbar/content/utils.js");loader.loadSubScript("chrome://ytoolbar/content/installerVariables.js");function YahooToolbarManager(){var _self=this;var _mInitialized=false;var _mFeedProcessor=null;var _mConfigManager=null;var _mYTLogger=null;var _mYahooFileIO=null;var _mCacheDir=null;var _mCacheFile=null;var _mBlindYID=null;var _mIsGuest=true;var _mChachedXUL=null;var _mDoPostFirstPageLoad=false;function _doPostInit(){try{var d_url=_mConfigManager.getCharValue("dataserver.url");var c_url=_mConfigManager.getCharValue("configserver.url");var lang=_mConfigManager.getCharValue("installer.language");if(lang==""){lang="us";}
d_url=d_url.replace("$CONFIG_INTL$",lang);c_url=c_url.replace("$CONFIG_INTL$",lang);yahooDebug("dataserver url:"+d_url+"config server url:"+c_url);_mLocalStorage.putString("yahoo.ytff.dataserver.url",d_url);_mLocalStorage.putString("yahoo.ytff.configserver.url",c_url);_mChachedXUL=_loadCachedXul();Components.classes["@mozilla.org/streamconv;1?from=text/y404&to=*/*"].createInstance(Components.interfaces.nsIYahooNavAssist).initialize();Components.classes["@yahoo.com/singleinstance;1"].getService(Components.interfaces.nsIYahooMailSingleInstance).initialize();}catch(e){yahooError("_doPostInit"+e);}};function _writeXulFile(){try{var toolbar=_mFeedProcessor.domBuilder.toolbar;if(!toolbar){return;}
var xul=yahooUtils.dumpXUL(toolbar,0);toolbar=null;xul=xul.replace(new RegExp("\x01","g"),"&#01;");xul=xul.replace(new RegExp("\x02","g"),"&#02;");xul=xul.replace(new RegExp("\x03","g"),"&#03;");xul=xul.replace(new RegExp("\x04","g"),"&#04;");xul=xul.replace(new RegExp("&","g"),"&amp;")
xul=xul.replace(new RegExp("\\?","g"),"&#63;")
xul=xul.replace(new RegExp("\\$","g"),"&#36;");xul=xul.replace(new RegExp("#document-fragment","g"),"toolbar");xul='<?xml version="1.0"  encoding="utf-8" ?>'+xul;xul=xul.replace(/class="chromeclass-toolbar"/,"");var file=_mYahooFileIO.getUserCacheDir();file.appendRelativePath("ytoolbar.xml");_mYahooFileIO.writeFile(file,xul);}catch(e){yahooError(e);}};function _loadCachedXul(){try{if(_mChachedXUL){yahooDebug("Loading toolbar from cached Xul");return _mChachedXUL;}else{var idir=_mYahooFileIO.getUserCacheDir();idir.appendRelativePath("ytoolbar.xml");var xmlContent=_mYahooFileIO.readFile(idir);if(xmlContent){var parser=Components.classes["@mozilla.org/xmlextras/domparser;1"].createInstance(Components.interfaces.nsIDOMParser);var toolbarxml=parser.parseFromString(xmlContent,"text/xml");var xslfile=Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Components.interfaces.nsIXMLHttpRequest);xslfile.open("GET","chrome://ytoolbar/skin/transform.xsl",false);xslfile.send(null);var processor=Components.classes["@mozilla.org/document-transformer;1?type=xslt"].createInstance(Components.interfaces.nsIXSLTProcessor);processor.importStylesheet(xslfile.responseXML);var domDocument=Components.classes["@mozilla.org/xul/xul-document;1"].createInstance(Components.interfaces.nsIDOMDocument);var ownerDocument=domDocument.implementation.createDocument("http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul","overlay",null);var idocumentFragment=processor.transformToFragment(toolbarxml,ownerDocument);var fc=idocumentFragment.firstChild;idocumentFragment.removeChild(idocumentFragment.firstChild);var retFrag=idocumentFragment.cloneNode(false);retFrag.appendChild(fc.firstChild);return retFrag;}}}catch(e){yahooError("loadXulCache:"+e);}
return null;};function _createCacheDir(){try{_mCacheDir=_mYahooFileIO.getUserCacheDir();_mCacheFile=_mCacheDir.clone().QueryInterface(Components.interfaces.nsILocalFile);_mCacheFile.setRelativeDescriptor(_mCacheDir,"feed");}catch(e){yahooError(e);}};function _checkCookies(){_mBlindYID=yahooNetUtils.getBlindYID();if(!_mCacheDir){_createCacheDir();}
_mIsGuest=true;if(_mBlindYID!=="default"){_mIsGuest=false;}
_mCacheDir=_mYahooFileIO.getUserCacheDir();_mCacheFile=_mCacheDir.clone().QueryInterface(Components.interfaces.nsILocalFile);_mCacheFile.appendRelativePath("feed");_self.BookmarkManager.createBM2CacheFile(_mCacheDir);};function _cacheFeed(){try{var rawFeed=_mFeedProcessor.raw;if(rawFeed){try{_checkCookies();if(_mCacheFile===null){return;}
if(!_mCacheFile.exists()){_mCacheFile.create(_mCacheFile.NORMAL_FILE_TYPE,0666);}
var out=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);out.init(_mCacheFile,0x20|0x02,00666,null);out.write(rawFeed,rawFeed.length);out.flush();out.close();yahooDebug("Inside cacheFeed Writing :"+_mCacheFile);}catch(e){yahooError(e);}}}catch(e){yahooError("_cacheFeed error : "+e);}};function _addListeners(feedProcessor,alertmgr,configmgr){var _ytbmgr=this;var ytbObserver={_observing:["cookie-changed","em-action-requested","quit-application-granted","yahoo-feed-updated"],prefSrvc:Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefBranch),obsSrvc:Components.classes["@mozilla.org/observer-service;1"].getService(Components.interfaces.nsIObserverService),localstorage:Components.classes["@yahoo.com/localstorage;1"].getService(Components.interfaces.nsIYahooLocalStorage),yahooUninstalled:false,yahooUninstallTracked:false,feedProc:null,alertmgr:null,configmgr:null,yahooUninstallTracked:false,yCookieChanged:false,tCookieChanged:false,notifier:Components.classes["@mozilla.org/observer-service;1"].getService(Components.interfaces.nsIObserverService),observe:function(subject,topic,data){try{if(topic=="cookie-changed"){var cookie=subject.QueryInterface(Components.interfaces.nsICookie);if(cookie.host!='.yahoo.com'){return;}
if(cookie.name=='Y'){this.yCookieChanged=true;}else if(cookie.name=='T'){this.tCookieChanged=true;}
if(this.yCookieChanged&&this.tCookieChanged){yahooDebug("Cookie Change detected. Triggering Toolbar refresh.");_checkCookies();this.tCookieChanged=false;this.yCookieChanged=false;try{this.alertmgr.clearSignedinData();this.feedProc.processServerFeed();}catch(e){yahooError("Error "+e);}}}
else if(topic=="em-action-requested"){subject.QueryInterface(Components.interfaces.nsIUpdateItem);if(subject.id=="{635abd67-4fe9-1b23-4f01-e679fa7484c1}"){if(data=="item-uninstalled"){this.yahooUninstalled=true;}else if(data=="item-cancel-action"){this.yahooUninstalled=false;}}}
else if(topic=="quit-application-granted"){if(this.yahooUninstalled&&!this.yahooUninstallTracked){var server=this.localstorage.getString("server");var lang=this.localstorage.getString("lang");var param;if(this.localstorage&&(param=this.localstorage.getString("lang"))){lang=param;}
var channel=this.localstorage.getString("channel");var nd=this.localstorage.getString("nd");var trackRemove=this.localstorage.getString("trackRemove");var url="http://"+server+"/moz/"+trackRemove+"/"+lang+"/"+channel+"/"+nd+"/*http://us.yimg.com/i/sh/bl.gif";var request=Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Components.interfaces.nsIXMLHttpRequest);request.open("GET",url,false);request.send(null);this.yahooUninstallTracked=true;var prefvalues=["yahoo.search.highlight","yahoo.supports.livesearch"];prefvalues.forEach(function(value){if(this.prefSrvc.prefHasUserValue(value)){this.prefSrvc.clearUserPref(value);}},this);_mYahooFileIO.cleanupCache();configmgr.cleanUp();}}else if(topic=="yahoo-feed-updated"){yahooDebug("Got yahoo-feed-updated");try{this.notifier.notifyObservers(this,"yahoo-toolbarxul-updated",null);if((this.configmgr.getBoolValue("xulcaching")===true)){yahooDebug("Writing to xul cache");_writeXulFile();_mChachedXUL=null;_mChachedXUL=_loadCachedXul();}
if(this.configmgr.getBoolValue("filefeedcaching")){yahooDebug("Writing cached feed");_cacheFeed();}}catch(e){yahooError("error "+e);}}
else if(data&&data.indexOf("yahoo.ytff.options")>-1){if(data=="yahoo.ytff.options.iconsonly"){this.feedProc.domBuilder.iconsOnly=_mConfigManager.getBoolValue("options.iconsonly");}}}catch(e){ytbDebug("error"+e);}},register:function(fp,alertmanager,configmgr){this.feedProc=fp;this.alertmgr=alertmanager;this.configmgr=configmgr;this._observing.forEach(function(topic){this.obsSrvc.addObserver(this,topic,false);},this);var pref=Components.classes["@mozilla.org/preferences;1"].getService(Components.interfaces.nsIPref);pref.addObserver("yahoo.ytff.options",this,false);}};ytbObserver.register(feedProcessor,alertmgr,configmgr);};this.LocalButtonProcessor=null;this.DOMBuilder=null;this.BookmarkManager=null;this.AlertManager=null;this.EventTipManager=null;this.isGuestMode=function(){return _mIsGuest;};this.isFeedLoaded=function(){return _mFeedProcessor.loaded;};this.initializeToolbar=function(){yahooDebug("initialize Toolbar...");if(_mInitialized==false){try{_mYahooFileIO=Components.classes["@yahoo.com/fileio;1"].getService(Components.interfaces.nsIYahooFileIO2);_mLocalStorage=Components.classes["@yahoo.com/localstorage;1"].getService(Components.interfaces.nsIYahooLocalStorage);_mConfigManager=Components.classes["@yahoo.com/configmanager;1"].getService(Components.interfaces.nsIYahooConfigManager);_self.AlertManager=Components.classes["@yahoo.com/alertmanager;1"].getService(Components.interfaces.nsIYahooAlertManager);_self.AlertManager.initAlerts(this);_mFeedProcessor=Components.classes["@yahoo.com/feed/processor;1"].getService(Components.interfaces.nsIYahooFeedProcessor);_mFeedProcessor.init(this);_self.LocalButtonProcessor=_mFeedProcessor.localButtonProcessor;_self.DOMBuilder=_mFeedProcessor.domBuilder;_self.BookmarkManager=_mFeedProcessor.bookmarkManager;_self.EventTipManager=Components.classes["@yahoo.com/eventtipmanager;1"].getService(Components.interfaces.nsIYahooEventTipManager);_self.EventTipManager.init(this);if(_mFeedProcessor.loaded==false){}else{yahooDebug("Feed Processor already loaded");}
_checkCookies();_mInitialized=true;}catch(e){yahooError(e);}}};this.shutdown=function(){if(_mInitialized){ytffLogger.shutdown();_mInitialized=false;Components.classes["@yahoo.com/singleinstance;1"].getService(Components.interfaces.nsIYahooMailSingleInstance).uninitialize();}};this.getLayoutButtons=function(groupID){return _mFeedProcessor.getLayout(groupID);};this.setLayoutButtons=function(layout,groupID){var date=new Date().toUTCString();_mConfigManager.setCharValue('toolbar.lastcust',date,true);_mConfigManager.setIntValue('toolbar.numfeed',0,true);_mFeedProcessor.setLayout(layout,groupID);};this.addButton=function(buttonID){var layout=buttonID;layout+=(_self.getLayoutButtons("grp_fav")!="")?",":"";layout+=_self.getLayoutButtons("grp_fav");_self.setLayoutButtons(layout,"grp_fav");};this.removeButton=function(buttonID){var layout=_self.getLayoutButtons("grp_fav");var index=layout.indexOf(buttonID);if(index==0){layout=layout.substr(buttonID.length+1);}else if(index>0){layout=layout.substring(0,index-1)+layout.substr(index+buttonID.length);}
_self.setLayoutButtons(layout,"grp_fav");};this.getToolbarXUL=function(){if(_mFeedProcessor&&_mFeedProcessor.loaded){yahooDebug("Loading xul from feedprocessor.");return _mFeedProcessor.domBuilder.toolbar;}else if(_mConfigManager.getBoolValue("xulcaching")){yahooDebug("Trying to load cached xul");return _loadCachedXul();}
return null;};this.getBookmark=function(){return _mFeedProcessor.domBuilder.bookmarks;};this.refreshBookmark=function(){yahooUtils.setTimeout(function(){_mFeedProcessor.bookmarkManager.processBookmarks(true);},5);};this.refreshToolbar=function(){_mFeedProcessor.processServerFeed();};this.saveAndRefreshToolbar=function(){_mFeedProcessor.saveAndReload();};this.saveToUDB=function(){_mFeedProcessor.saveToUDB();};this.doPostFirstPageLoad=function(){try{if(_mDoPostFirstPageLoad==false){_mFeedProcessor.processServerFeed();_mDoPostFirstPageLoad=true;}}catch(e){yahooError("ToolbarManager::_doPostFirstPageLoad :"+e);}};this.observe=function(aSubject,aTopic,aData){return NS_OK;};this.QueryInterface=function(iid){if(!iid.equals(Components.interfaces.nsIYahooToolbarManager)&&!iid.equals(Components.interfaces.nsISupports)&&!iid.equals(Components.interfaces.nsIRunnable)&&!iid.equals(Components.interfaces.nsIObserver)){throw Components.results.NS_ERROR_NO_INTERFACE;}
return _self;};try{this.initializeToolbar();_doPostInit();_addListeners(_mFeedProcessor,this.AlertManager,_mConfigManager);}catch(e){yahooError("Error initializing Toolbar : "+e);}};function NSGetModule(compMgr,fileSpec){return{myCID:Components.ID("{DDEAD770-3CE9-48de-B08F-F35D36594911}"),myProgID:"@yahoo.com/yahootoolbarmanager;1",firstTime:true,registerSelf:function(compMgr,fileSpec,location,type){if(this.firstTime){this.firstTime=false;throw Components.results.NS_ERROR_FACTORY_REGISTER_AGAIN;}
compMgr=compMgr.QueryInterface(Components.interfaces.nsIComponentRegistrar);compMgr.registerFactoryLocation(this.myCID,"Yahoo! Toolbar Manager",this.myProgID,fileSpec,location,type);try{var _isrvMgr=compMgr.QueryInterface(Components.interfaces.nsIServiceManager);if(_isrvMgr!=null){var _catMgr=null;_isrvMgr.getServiceByContractID(NS_CATEGORYMANAGER_CONTRACTID,NS_GET_IID(this.Component.interfaces.nsICategoryManager),_catMgr);if(_catMgr!=null){var iprev=_catMgr.AddCategoryEntry("xpcom-startup","Yahoo! Toolbar Manager",this.myCID,PR_TRUE,PR_TRUE);if(iprev!=null){}}}}catch(e){}},getClassObject:function(compMgr,cid,iid){if(!cid.equals(this.myCID)){throw Components.results.NS_ERROR_NO_INTERFACE;}
if(!iid.equals(Components.interfaces.nsIFactory)){throw Components.results.NS_ERROR_NOT_IMPLEMENTED;}
return this.myFactory;},myFactory:{createInstance:function(outer,iid){if(outer!==null){throw Components.results.NS_ERROR_NO_AGGREGATION;}
return new YahooToolbarManager().QueryInterface(iid);}},canUnload:function(compMgr){return true;}};}