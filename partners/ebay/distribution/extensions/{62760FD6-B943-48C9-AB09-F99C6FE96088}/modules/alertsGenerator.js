/* Copyright (C) 2007-2011 eBay Inc. All Rights Reserved. */const EXPORTED_SYMBOLS=["AlertsGenerator"];const Cc=Components.classes;const Ci=Components.interfaces;const Ce=Components.Exception;const Cr=Components.results;const Cu=Components.utils;var AlertsGenerator={_init:function(){try{Cu.import("resource://ebaycompanion/helpers/logger.js");Cu.import("resource://ebaycompanion/helpers/observers.js");Cu.import("resource://ebaycompanion/helpers/itemList.js");Cu.import("resource://ebaycompanion/helpers/timer.js");Cu.import("resource://ebaycompanion/helpers/warningNotificationHelper.js");Cu.import("resource://ebaycompanion/datasource.js");Cu.import("resource://ebaycompanion/constants.js");Cu.import("resource://ebaycompanion/objects/alert.js");Cu.import("resource://ebaycompanion/objects/item.js");Cu.import("resource://ebaycompanion/objects/feedback.js");Cu.import("resource://ebaycompanion/objects/notification.js");this._observers=new Observers;let that=this;this._enabled=false;this._observers.add(function()that._uninit(),"quit-application-granted");this._observers.add(function(subject,topic,data){if(data=="Hard Update"){if(!that._enabled){that.enable();}}},"ebay-update-finished");this._observers.add(function(subject,topic,data){if(that._enabled){that._newItem(subject.object);}},"ebay-item-new");this._observers.add(function(subject,topic,data){if(that._enabled){that._itemChanged(subject.object,subject.originalObject);}},"ebay-item-changed");this._observers.add(function(subject,topic,data){if(that._enabled){that._newTransaction(subject.object);}},"ebay-transaction-new");this._observers.add(function(subject,topic,data)
that._accountFeedbackScoreChanged(subject.object,subject.originalObject),"ebay-account-feedback-changed");}catch(e){Logger.exception(e);}},_uninit:function(){try{this._observers.removeAll();}
catch(e){Logger.exception(e);}},enable:function(){let that=this;this._endingSoonList=new ItemList();this._endingSoonAlerted={};this._enabled=true;this._endingSoonList.filter(function(item){let alreadyAlerted=that._endingSoonAlerted[item.get("itemId")];return!item.get("isEnded")&&!alreadyAlerted;});this._endingSoonTimer=new Timer(function()that._checkForEndingSoon(),1000*60,Timer.TYPE_REPEATING_SLACK);this._checkForEndingSoon();},disable:function(){this._enabled=false;if(this._endingSoonAlerted){this._endingSoonTimer.cancel();}},_checkForEndingSoon:function(){try{this._endingSoonList.filter();this._endingSoonList.sort(function(a,b){return a.get("endTime")<b.get("endTime");});let items=this._endingSoonList.filteredItems;let mayBeMore=true;for(let i=0;mayBeMore&&i<items.length;i++){let item=items[i];mayBeMore=this._checkItemForEndingSoon(item);}}
catch(e){Logger.exception(e);}},_checkItemForEndingSoon:function(item){let alertGenerated=false;let that=this;if(item.get("isEnded")){if(!this._preventItemEndedNotification){let notification=new Notification(WarningNotificationHelper.ITEM_MOVED_TO_ENDED_TAB_WARNING);notification.addLinkCallback(0,function(aEvent){let windowMediator=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);let mostRecentWindow=windowMediator.getMostRecentWindow("navigator:browser");let sidebar=mostRecentWindow.document.getElementById("sidebar");sidebar.contentWindow.Sidebar.switchToTab(1);});notification.set("content",Constants.stringBundle.getString("ecSidebar.notification.info.ended"));notification.set("priority",1);WarningNotificationHelper.queueNotification(notification);this._preventItemEndedNotification=true;new Timer(function(){that._preventItemEndedNotification=false;},1000*30,Timer.TYPE_ONE_SHOT);return alertGenerated;}}
let userIsSeller=item.get("sellerUserId").toLowerCase()==Datasource.activeAccount().get("userId").toLowerCase();let hasTransactions=Datasource.transactions([item.get("itemId")])!=null;if(hasTransactions&&!userIsSeller){return alertGenerated;}
let timeLeft=item.get("endTime")-Datasource.getEbayTime().getTime();let minutesLeft=timeLeft/1000/60;if(timeLeft>0&&minutesLeft<20){if(userIsSeller){this._generateAlert(Alert.ALERT_TYPE_SELLING_ENDING_SOON,item);}else{let userHasBid=item.get("userMaxBid")>0;if(userHasBid){this._generateAlert(Alert.ALERT_TYPE_BIDDING_ENDING_SOON,item);}else{this._generateAlert(Alert.ALERT_TYPE_WATCHING_ENDING_SOON,item);}}
this._endingSoonAlerted[item.get("itemId")]=true;alertGenerated=true;}else if(timeLeft<=0){if(!this._preventItemEndedNotification){let notification=new Notification(WarningNotificationHelper.ITEM_MOVED_TO_ENDED_TAB_WARNING);notification.addLinkCallback(0,function(aEvent){let windowMediator=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);let mostRecentWindow=windowMediator.getMostRecentWindow("navigator:browser");let sidebar=mostRecentWindow.document.getElementById("sidebar");sidebar.contentWindow.Sidebar.switchToTab(1);});notification.set("content",Constants.stringBundle.getString("ecSidebar.notification.info.ended"));notification.set("priority",1);WarningNotificationHelper.queueNotification(notification);alertGenerated=true;this._preventItemEndedNotification=true;new Timer(function(){that._preventItemEndedNotification=false;},1000*30,Timer.TYPE_ONE_SHOT);}}
return alertGenerated;},_newItem:function(item){try{this._checkItemForEndingSoon(item);}
catch(e){Logger.exception(e);}},_itemChanged:function(item,originalItem){let userId=Datasource.activeAccount().get("userId");let userIsSeller=item.get("sellerUserId").toLowerCase()==userId.toLowerCase();let itemJustEnded=item.get("isEnded")!=originalItem.get("isEnded");let userHasBid=item.get("userMaxBid")>0;let highBidder=item.get("highBidderId");let userIsHighBidder=highBidder&&(highBidder.toLowerCase()==userId.toLowerCase());let oldHighBidder=originalItem.get("highBidderId");let userWasHighBidder=oldHighBidder&&(oldHighBidder.toLowerCase()==userId.toLowerCase());let originalOfferStatus=originalItem.get("bestOfferStatus");let currentOfferStatus=item.get("bestOfferStatus");let offerWasPending=(originalOfferStatus&&originalOfferStatus.toLowerCase()=="pending");let offerWasCountered=(originalOfferStatus&&originalOfferStatus.toLowerCase()=="countered");let offerIsDeclined=(currentOfferStatus&&currentOfferStatus.toLowerCase()=="declined");let offerIsExpired=(currentOfferStatus&&currentOfferStatus.toLowerCase()=="expired");let offerIsCountered=(currentOfferStatus&&currentOfferStatus.toLowerCase()=="countered");let bestOfferDeclined=(offerWasPending||offerWasCountered)&&offerIsDeclined;let bestOfferExpired=(offerWasPending||offerWasCountered)&&offerIsExpired;let bestOfferCountered=offerWasPending&&offerIsCountered;let EC_LISTING_TYPE_FIXED="FixedPriceItem";let EC_LISTING_TYPE_STORE_FIXED="StoresFixedPrice";let itemHasBuyItNow=item.get("hasBuyItNow");let listingFormat=item.get("listingFormat");let isBINItem=(EC_LISTING_TYPE_STORE_FIXED==listingFormat||EC_LISTING_TYPE_FIXED==listingFormat)&&itemHasBuyItNow;let buyerWon=(!userIsSeller&&item.get("userQuantityWinning")>originalItem.get("userQuantityWinning")&&item.get("quantityRemaining")<originalItem.get("quantityRemaining"))||(!userIsSeller&&!userWasHighBidder&&userIsHighBidder&&item.get("quantityRemaining")<originalItem.get("quantityRemaining"));if(userIsSeller){let soldNone=item.get("quantitySold")==0;let newBidPlaced=item.get("numBids")>originalItem.get("numBids");let newOfferPlaced=item.get("bestOfferCount")>originalItem.get("bestOfferCount");if(itemJustEnded&&soldNone){this._generateAlert(Alert.ALERT_TYPE_SELLING_ITEM_UNSOLD,item);}else if(newBidPlaced){this._generateAlert(Alert.ALERT_TYPE_SELLING_BID_PLACED,item);}else if(itemJustEnded){this._generateAlert(Alert.ALERT_TYPE_ITEM_ENDED,item);}else if(newOfferPlaced){this._generateAlert(Alert.ALERT_TYPE_SELLING_BESTOFFER_NEWOFFER,item);}}else if(userHasBid||(isBINItem&&buyerWon)){let priceIncreased=item.get("currentPrice")>originalItem.get("currentPrice");if(itemJustEnded){if(!userIsHighBidder){this._generateAlert(Alert.ALERT_TYPE_BIDDING_ITEM_LOST,item);}}else if(!isBINItem){if(priceIncreased){if(userIsHighBidder&&userWasHighBidder){this._generateAlert(Alert.ALERT_TYPE_BIDDING_RAISED_BID,item);}else if(userIsHighBidder&&!userWasHighBidder){this._generateAlert(Alert.ALERT_TYPE_BIDDING_HIGH_BIDDER,item);}else if(!userIsHighBidder&&userWasHighBidder){this._generateAlert(Alert.ALERT_TYPE_BIDDING_OUTBID,item);}}else{if(!userWasHighBidder&&userIsHighBidder){this._generateAlert(Alert.ALERT_TYPE_BIDDING_HIGH_BIDDER,item);}}}}else if(isBINItem&&bestOfferDeclined){this._generateAlert(Alert.ALERT_TYPE_BIDDING_BESTOFFER_DECLINED,item);}else if(isBINItem&&bestOfferExpired){this._generateAlert(Alert.ALERT_TYPE_BIDDING_BESTOFFER_EXPIRED,item);}else if(isBINItem&&bestOfferCountered){this._generateAlert(Alert.ALERT_TYPE_BIDDING_BESTOFFER_COUNTERED,item);}},_newTransaction:function(transaction){let item=Datasource.items()[transaction.get("itemId")];if(item){let userIsSeller=item.get("sellerUserId").toLowerCase()==Datasource.activeAccount().get("userId").toLowerCase();let endedCopy=item.copy();endedCopy.set("isEnded",true);endedCopy.transaction=transaction.copy();let alertType;let generateAlert=true;if(userIsSeller){endedCopy.type=Item.ITEM_TYPE_SOLD;if(endedCopy.get("currentPrice")!=endedCopy.transaction.get("transactionPrice")){alertType=Alert.ALERT_TYPE_SELLING_BESTOFFER_ITEM_SOLD;}else{alertType=Alert.ALERT_TYPE_SELLING_ITEM_SOLD;}}else{let EC_LISTING_TYPE_FIXED="FixedPriceItem";let EC_LISTING_TYPE_STORE_FIXED="StoresFixedPrice";let listingFormat=endedCopy.get("listingFormat");if((EC_LISTING_TYPE_STORE_FIXED==listingFormat||EC_LISTING_TYPE_FIXED==listingFormat)){if(endedCopy.get("currentPrice")!=endedCopy.transaction.get("transactionPrice")){endedCopy.type=Item.ITEM_TYPE_WON;alertType=Alert.ALERT_TYPE_BIDDING_BESTOFFER_ITEM_WON;}else{generateAlert=false;}}else{endedCopy.type=Item.ITEM_TYPE_WON;alertType=Alert.ALERT_TYPE_BIDDING_ITEM_WON;}}
if(generateAlert){this._generateAlert(alertType,endedCopy);}}},_accountFeedbackScoreChanged:function(aAccount,aOriginalAccount){let oldFeedbackValue=aOriginalAccount.get("feedbackRating");let newFeedbackValue=aAccount.get("feedbackRating");let preventAlertDisplay=Constants.prefBranch.get("prevent.first.feedback.score.notification");if(newFeedbackValue>oldFeedbackValue&&!preventAlertDisplay){let listLength=Feedback.MILESTONES.length;let showedScoreAlert=false;let feedback;for(var i=listLength-1;!showedScoreAlert&&i>=0;i--){if((Feedback.MILESTONES[i]>oldFeedbackValue)&&(Feedback.MILESTONES[i]<=newFeedbackValue)){feedback=new Feedback();feedback.score=Feedback.MILESTONES[i];this._generateAlert(Alert.ALERT_TYPE_FEEDBACK_SCORE,feedback);showedScoreAlert=true;}}}},_generateAlert:function(aType,aObject){let alert=new Alert(aType,aObject);alert.dispatch();}};AlertsGenerator._init();