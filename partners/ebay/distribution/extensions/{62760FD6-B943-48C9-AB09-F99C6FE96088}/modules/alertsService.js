/* Copyright (C) 2007-2011 eBay Inc. All Rights Reserved. */const EXPORTED_SYMBOLS=["AlertsService"];const Cc=Components.classes;const Ci=Components.interfaces;const Ce=Components.Exception;const Cr=Components.results;const Cu=Components.utils;const EBAYCOMP_ALERT_PREFERENCE_MAP=["bidding.endingSoon","bidding.outbid","bidding.highBidder","bidding.raisedBid","bidding.itemWon","bidding.itemLost","watching.endingSoon","selling.endingSoon","selling.itemSold","selling.itemUnsold","selling.bidPlaced","selling.reserveMet","feedbackScore","itemEnded","bidding.bestOffer.declined","bidding.bestOffer.expired","bidding.bestOffer.countered","bidding.bestOffer.itemWon","selling.bestOffer.itemSold","selling.bestOffer.newOffer"];Cu.import("resource://ebaycompanion/helpers/logger.js");Cu.import("resource://ebaycompanion/helpers/observers.js");Cu.import("resource://ebaycompanion/helpers/timer.js");Cu.import("resource://ebaycompanion/datasource.js");Cu.import("resource://ebaycompanion/constants.js");Cu.import("resource://ebaycompanion/objects/item.js");Cu.import("resource://ebaycompanion/objects/alert.js");Cu.import("resource://ebaycompanion/objects/feedback.js");var AlertsService={_observers:null,_primaryAlertsQueue:new Array(),_primaryAlertsIndex:-1,_secondaryAlertsQueue:new Array(),_sleptAlertsQueue:new Array(),_awakeAlertsTimer:null,_alertDisplayed:false,_purgeEndingSoonTimer:null,_soundService:null,_init:function(){let that=this;this._soundService=Cc["@mozilla.org/sound;1"].getService(Ci.nsISound);try{this._soundService.init();}catch(e){Logger.error("There was an error initializing the sound service: "+e);}
this._observers=new Observers;this._clearAlertsQueues();this._observers.add(function(){that._uninit()},"quit-application-granted");this._observers.add(function(){that._clearAlertsQueues();},"ebay-account-logged-out");this._observers.add(function(aAlert){that._queueAlert(aAlert);},"ebay-alert-dispatched");this._observers.add(function(aSubject,aTopic,aData){that._removeItemAlerts(aSubject.object);},"ebay-item-removed");this._observers.add(function(aSubject,aTopic,aData){that._removeItemAlerts(aSubject.object,true);},"ebay-secondary-alert-dismissed");this._observers.add(function(aInfo){let item=aInfo.object;that._updateAlertsInfo(item);},"ebay-item-changed");this._observers.add(function(aInfo){let transaction=aInfo.object;that._updateAlertsInfo(transaction);},"ebay-transaction-changed");this._purgeEndingSoonTimer=new Timer(function(){that.purgeEndingSoonAlerts();},10000,Timer.TYPE_REPEATING_SLACK)},_uninit:function(){try{this._observers.removeAll();this._purgeEndingSoonTimer.cancel();}catch(e){Logger.exception(e);}},getPrimaryAlertsIndex:function(){return this._primaryAlertsIndex;},getPrimaryAlertsSize:function(){return this._primaryAlertsQueue.length;},getCurrentPrimaryAlert:function(){let currentAlert=null;if(0<this._primaryAlertsQueue.length){currentAlert=this._primaryAlertsQueue[this._primaryAlertsIndex];}
return currentAlert;},_clearAlertsQueues:function(){this._primaryAlertsQueue=new Array();this._primaryAlertsIndex=-1;this._secondaryAlertsQueue=new Array();this._sleptAlertsQueue=new Array();if(this._awakeAlertsTimer){this._awakeAlertsTimer.cancel();delete this._awakeAlertsTimer;}
Observers.notify(null,"ebay-alert-close-item",null);},_queueAlert:function(aAlert){this._dismissDependentAlerts(aAlert);if(this._canShowAlertType(aAlert.type)){if(this._isPrimaryAlert(aAlert.type)){this._primaryAlertsQueue.push(aAlert);if(this._primaryAlertsIndex==-1){this._primaryAlertsIndex=0;}
Observers.notify(aAlert,"ebay-alert-show-primary",null);this._displaySystemNotification(aAlert);if(Constants.prefBranch.get("alerts.enableSound")){this._generateSoundForAlert(aAlert);}}else{this._secondaryAlertsQueue.push(aAlert);Observers.notify(aAlert,"ebay-alert-show-secondary",null);}}else{Logger.log("This alert type cannot be shown. Type: "+aAlert.type);}},_canShowAlertType:function(aAlertType){return aAlertType!=Alert.ALERT_TYPE_ITEM_ENDED&&Constants.prefBranch.get("alerts."+EBAYCOMP_ALERT_PREFERENCE_MAP[aAlertType]+".isEnabled");},_isPrimaryAlert:function(aAlertType){return Constants.prefBranch.get("alerts."+EBAYCOMP_ALERT_PREFERENCE_MAP[aAlertType]+".isPrimary");},_dismissDependentAlerts:function(aAlert){let dismissTypes=this._getDismissedAlertTypes(aAlert.type);let queueLength;let alert;let alertObject;let dismissAlertList=new Array();if(dismissTypes!=null){queueLength=this._primaryAlertsQueue.length;for(var i=0;i<queueLength;i++){alert=this._primaryAlertsQueue[i];alertObject=alert.object;if(alertObject instanceof Item&&aAlert.object instanceof Item){if(alertObject.get("itemId")==aAlert.object.get("itemId")){for(var j=0;j<dismissTypes.length;j++){if(alert.type==dismissTypes[j]){dismissAlertList.push(alert);break;}}}}else if(alertObject instanceof Feedback&&aAlert.object instanceof Feedback){for(var h=0;h<dismissTypes.length;h++){if(alert.type==dismissTypes[h]){dismissAlertList.push(alert);break;}}}}
queueLength=this._secondaryAlertsQueue.length;for(var r=0;r<queueLength;r++){alert=this._secondaryAlertsQueue[r];alertObject=alert.object;if(alertObject instanceof Item&&aAlert.object instanceof Item){if(alertObject.get("itemId")==aAlert.object.get("itemId")){for(var s=0;s<dismissTypes.length;s++){if(alert.type==dismissTypes[s]){dismissAlertList.push(alert);break;}}}}}
queueLength=this._sleptAlertsQueue.length;for(var r=0;r<queueLength;r++){alert=this._sleptAlertsQueue[r];alertObject=alert.object;if(alertObject instanceof Item&&aAlert.object instanceof Item){if(alertObject.get("itemId")==aAlert.object.get("itemId")){for(var s=0;s<dismissTypes.length;s++){if(alert.type==dismissTypes[s]){dismissAlertList.push(alert);break;}}}}}
for(var t=0;t<dismissAlertList.length;t++){this.dismissAlert(dismissAlertList[t]);}}},_getDismissedAlertTypes:function(aAlertType){let dismissedTypes=null;switch(aAlertType){case Alert.ALERT_TYPE_ITEM_ENDED:dismissedTypes=[Alert.ALERT_TYPE_WATCHING_ENDING_SOON,Alert.ALERT_TYPE_BIDDING_ENDING_SOON,Alert.ALERT_TYPE_SELLING_ENDING_SOON];break;case Alert.ALERT_TYPE_BIDDING_ITEM_WON:case Alert.ALERT_TYPE_BIDDING_BESTOFFER_ITEM_WON:case Alert.ALERT_TYPE_BIDDING_ITEM_LOST:dismissedTypes=[Alert.ALERT_TYPE_WATCHING_ENDING_SOON,Alert.ALERT_TYPE_BIDDING_ENDING_SOON,Alert.ALERT_TYPE_BIDDING_RAISED_BID,Alert.ALERT_TYPE_BIDDING_OUTBID,Alert.ALERT_TYPE_BIDDING_HIGH_BIDDER];break;case Alert.ALERT_TYPE_SELLING_ITEM_SOLD:case Alert.ALERT_TYPE_SELLING_BESTOFFER_ITEM_SOLD:dismissedTypes=[Alert.ALERT_TYPE_SELLING_ITEM_UNSOLD,Alert.ALERT_TYPE_SELLING_ENDING_SOON,Alert.ALERT_TYPE_SELLING_BID_PLACED];break;case Alert.ALERT_TYPE_SELLING_ITEM_UNSOLD:dismissedTypes=[Alert.ALERT_TYPE_SELLING_ENDING_SOON,Alert.ALERT_TYPE_SELLING_BID_PLACED];break;case Alert.ALERT_TYPE_BIDDING_OUTBID:dismissedTypes=[Alert.ALERT_TYPE_BIDDING_RAISED_BID,Alert.ALERT_TYPE_BIDDING_HIGH_BIDDER];break;case Alert.ALERT_TYPE_BIDDING_RAISED_BID:dismissedTypes=[Alert.ALERT_TYPE_BIDDING_OUTBID,Alert.ALERT_TYPE_BIDDING_HIGH_BIDDER];break;case Alert.ALERT_TYPE_BIDDING_HIGH_BIDDER:dismissedTypes=[Alert.ALERT_TYPE_BIDDING_OUTBID,Alert.ALERT_TYPE_BIDDING_RAISED_BID];break;case Alert.ALERT_TYPE_SELLING_BID_PLACED:dismissedTypes=[Alert.ALERT_TYPE_SELLING_BID_PLACED];break;case Alert.ALERT_TYPE_BIDDING_BESTOFFER_EXPIRED:dismissedTypes=[Alert.ALERT_TYPE_BIDDING_BESTOFFER_COUNTERED];break;case Alert.ALERT_TYPE_BIDDING_BESTOFFER_DECLINED:dismissedTypes=[Alert.ALERT_TYPE_BIDDING_BESTOFFER_COUNTERED];break;case Alert.ALERT_TYPE_BIDDING_BESTOFFER_COUNTERED:dismissedTypes=[Alert.ALERT_TYPE_BIDDING_BESTOFFER_COUNTERED];break;case Alert.ALERT_TYPE_FEEDBACK_SCORE:dismissedTypes=[Alert.ALERT_TYPE_FEEDBACK_SCORE];break;}
return dismissedTypes;},dismissAlert:function(aAlert,aSkipSleptAlerts){let removed=false;let queueLength;if(!aSkipSleptAlerts){queueLength=this._sleptAlertsQueue.length;for(var k=0;k<queueLength;k++){if(aAlert.equals(this._sleptAlertsQueue[k])){this._sleptAlertsQueue.splice(k,1);removed=true;break;}}
if(this._sleptAlertsQueue.length==0&&this._awakeAlertsTimer){this._awakeAlertsTimer.cancel();delete this._awakeAlertsTimer;}}
queueLength=this._primaryAlertsQueue.length;for(var i=0;i<queueLength;i++){if(aAlert.equals(this._primaryAlertsQueue[i])){this._primaryAlertsQueue.splice(i,1);removed=true;break;}}
if(!removed){queueLength=this._secondaryAlertsQueue.length;for(var j=0;j<queueLength;j++){if(aAlert.equals(this._secondaryAlertsQueue[j])){this._secondaryAlertsQueue.splice(j,1);removed=true;break;}}}
if(removed){if(0<this._primaryAlertsQueue.length){this._primaryAlertsIndex=0;let currentAlert=this.getCurrentPrimaryAlert();Observers.notify(currentAlert,"ebay-alert-show-item",null);}else{Observers.notify(null,"ebay-alert-close-item",null);}}},_removeItemAlerts:function(aItem,aOnlySecondary){let alert;let removed=false;let dismissAlertList=new Array();if(!aOnlySecondary){for(var i=0;i<this._primaryAlertsQueue.length;i++){alert=this._primaryAlertsQueue[i];if(alert.object instanceof Item){if(alert.object.get("itemId")==aItem.get("itemId")){this._primaryAlertsQueue.splice(i,1);removed=true;}}}
for(var r=0;r<this._sleptAlertsQueue.length;r++){alert=this._sleptAlertsQueue[r];let alertObject=alert.object;if(alertObject instanceof Item){if(alertObject.get("itemId")==aItem.get("itemId")){this._sleptAlertsQueue.splice(r,1);removed=true;}}}
if(this._sleptAlertsQueue.length==0&&this._awakeAlertsTimer){this._awakeAlertsTimer.cancel();delete this._awakeAlertsTimer;}}
for(var j=0;j<this._secondaryAlertsQueue.length;j++){alert=this._secondaryAlertsQueue[j];if(alert.object instanceof Item){if(alert.object.get("itemId")==aItem.get("itemId")){this._secondaryAlertsQueue.splice(j,1);removed=true;}}}
if(removed&&!aOnlySecondary){if(0<this._primaryAlertsQueue.length){this._primaryAlertsIndex=0;let currentAlert=this.getCurrentPrimaryAlert();Observers.notify(currentAlert,"ebay-alert-show-item",null);}else{Observers.notify(null,"ebay-alert-close-item",null);}}},applySecondaryAlerts:function(){let alert;if(this._secondaryAlertsQueue){for(var i=0;i<this._secondaryAlertsQueue.length;i++){alert=this._secondaryAlertsQueue[i];Observers.notify(alert,"ebay-alert-show-secondary",null);}}},_displaySystemNotification:function(aAlert){let windowMediator=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);let mostRecentWindow=windowMediator.getMostRecentWindow("navigator:browser");let icon;let title;let message;let clickListener;if(mostRecentWindow){mostRecentWindow.getAttention();}
if(mostRecentWindow.EbayCompanion.userIsAway&&aAlert.type!=Alert.ALERT_TYPE_FEEDBACK_SCORE){icon="chrome://ebaycompanion/skin/images/extension-icon.png";let typePref=EBAYCOMP_ALERT_PREFERENCE_MAP[aAlert.type];let that=this;title=Constants.stringBundle.getString("ecAlert."+typePref+".title");message=Constants.getUTF8(aAlert.object.get("title"));clickListener={observe:function(aSubject,aTopic,aData){if(aTopic=="alertclickcallback"&&mostRecentWindow!=null){mostRecentWindow.focus();that.showCurrentAlerts();}else if(aTopic=="alertfinished"){that._alertDisplayed=false;}}};if(!this._alertDisplayed){this._alertDisplayed=true;let alertsService=Cc["@mozilla.org/alerts-service;1"].getService(Ci.nsIAlertsService);alertsService.showAlertNotification(icon,title,message,true,"",clickListener);}}},_generateSoundForAlert:function(aAlert){const ALERT_DIR="chrome://ebaycompanion/skin/sounds/";const ALERT_GENERIC=ALERT_DIR+"alert-generic.wav";const ALERT_OUTBID=ALERT_DIR+"alert-outbid.wav";const ALERT_SUCCESS=ALERT_DIR+"alert-success.wav";let soundURL=Cc["@mozilla.org/network/standard-url;1"].createInstance(Ci.nsIURL);switch(aAlert.type){case Alert.ALERT_TYPE_BIDDING_ITEM_WON:case Alert.ALERT_TYPE_SELLING_ITEM_SOLD:case Alert.ALERT_TYPE_BIDDING_BESTOFFER_ITEM_WON:case Alert.ALERT_TYPE_SELLING_BESTOFFER_NEWOFFER:case Alert.ALERT_TYPE_SELLING_BESTOFFER_ITEM_SOLD:soundURL.spec=ALERT_SUCCESS;break;case Alert.ALERT_TYPE_BIDDING_OUTBID:case Alert.ALERT_TYPE_BIDDING_BESTOFFER_DECLINED:case Alert.ALERT_TYPE_BIDDING_BESTOFFER_EXPIRED:soundURL.spec=ALERT_OUTBID;break;case Alert.ALERT_TYPE_FEEDBACK_SCORE:soundURL=null;break;default:soundURL.spec=ALERT_GENERIC;break;}
if(soundURL){try{this._soundService.play(soundURL);}catch(e){Logger.error("Unable to play sound: "+soundURL.spec+". "+e);}}},moveToPreviousAlert:function(){if(0<this._primaryAlertsIndex){this._primaryAlertsIndex--;let currentAlert=this.getCurrentPrimaryAlert();Observers.notify(currentAlert,"ebay-alert-show-item",null);}},moveToNextAlert:function(){if(this._primaryAlertsIndex<this._primaryAlertsQueue.length-1){this._primaryAlertsIndex++;let currentAlert=this.getCurrentPrimaryAlert();Observers.notify(currentAlert,"ebay-alert-show-item",null);}},remindLater:function(){let currentAlert=this.getCurrentPrimaryAlert();this._sleptAlertsQueue.push(currentAlert);this.dismissAlert(currentAlert,true);if(this._sleptAlertsQueue.length==1){const AWAKE_ALERTS_TIMER_INTERVAL=30*1000;let that=this;this._awakeAlertsTimer=new Timer(function(){that._awakeAlerts();},AWAKE_ALERTS_TIMER_INTERVAL,Timer.TYPE_REPEATING_SLACK);}},_awakeAlerts:function(){if(this._sleptAlertsQueue.length>0){let awakenedAlerts=new Array();let alert;let item;let timeLeft;for(var i=0;i<this._sleptAlertsQueue.length;i++){alert=this._sleptAlertsQueue[i];item=alert.object;timeLeft=item.get("endTime")-Datasource.getEbayTime().getTime();let minutesLeft=timeLeft/1000/60;if(minutesLeft<5){if(Datasource.items()[item.get("itemId")]){this._queueAlert(alert);}
awakenedAlerts.push(alert);}}
for(var j=0;j<awakenedAlerts.length;j++){for(var k=0;k<this._sleptAlertsQueue.length;k++){if(awakenedAlerts[j].equals(this._sleptAlertsQueue[k])){this._sleptAlertsQueue.splice(k,1);}}}
if(this._sleptAlertsQueue.length==0){this._awakeAlertsTimer.cancel();delete this._awakeAlertsTimer;}}},showCurrentAlerts:function(){if(0<this._primaryAlertsQueue.length){let currentAlert=this.getCurrentPrimaryAlert();if(this._canShowAlertType(currentAlert.type)){if(this._isPrimaryAlert(currentAlert.type)){Observers.notify(currentAlert,"ebay-alert-show-primary",null);}}}else{Observers.notify(null,"ebay-alert-close-item",null);}},purgeEndingSoonAlerts:function(){let queueLength=this._primaryAlertsQueue.length;let alert;let item;for(var i=0;i<queueLength;i++){alert=this._primaryAlertsQueue[i];if(alert&&(alert.type==Alert.ALERT_TYPE_BIDDING_ENDING_SOON||alert.type==Alert.ALERT_TYPE_SELLING_ENDING_SOON||alert.type==Alert.ALERT_TYPE_WATCHING_ENDING_SOON)){item=alert.object;let endTime=item.get("endTime");let ebayTime=Datasource.getEbayTime().getTime();let timeLeft=Math.max(0,endTime-ebayTime);if(timeLeft==0){this.dismissAlert(alert,true);}}}},_updateAlertsInfo:function(aObject){let queueLength;let alert;let alertObject;let objectIsItem=(aObject instanceof Item);let itemId=aObject.get("itemId")
queueLength=this._primaryAlertsQueue.length;for(var i=0;i<queueLength;i++){alert=this._primaryAlertsQueue[i];alertObject=alert.object;if(alertObject instanceof Item){if(alertObject.get("itemId")==itemId){if(!objectIsItem){if(alertObject.transaction&&alertObject.transaction.get("transactionId")==aObject.get("transactionId")){alert.object.transaction=aObject.copy();}}else{let updatedObject=aObject.copy();updatedObject.type=alert.object.type;updatedObject.transaction=alert.object.transaction;alert.object=updatedObject;}}}}
queueLength=this._sleptAlertsQueue.length;for(var r=0;r<queueLength;r++){alert=this._sleptAlertsQueue[r];alertObject=alert.object;if(alertObject instanceof Item){if(alertObject.get("itemId")==itemId){if(!objectIsItem){if(alertObject.transaction&&alertObject.transaction.get("transactionId")==aObject.get("transactionId")){alert.object.transaction=aObject.copy();}}else{if(!alertObject.transaction){alert.object=aObject.copy();}}}}}}};AlertsService._init();