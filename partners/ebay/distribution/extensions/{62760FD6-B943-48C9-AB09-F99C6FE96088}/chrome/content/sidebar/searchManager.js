/* Copyright (C) 2007-2011 eBay Inc. All Rights Reserved. */Cu.import("resource://glaxebay/gsCommon.js");Cu.import("resource://ebaycompanion/autocompleteService.js");Sidebar.SearchManager={_searchTextbox:null,_searchPanel:null,_searchTimer:null,_searchQuery:null,init:function(){this._searchPanel=document.getElementById("gs-ebay-search-panel");this._searchTextbox=document.getElementById("gs-ebay-search-textbox");GlaxEbay.ObserverService.addObserver(this,AutocompleteService.TOPIC_RESULTS_RETURNED,false);},uninit:function(){this._searchTimer=null;this._searchPanel=null;this._searchQuery=null;this._searchTextbox=null;GlaxEbay.ObserverService.removeObserver(this,AutocompleteService.TOPIC_RESULTS_RETURNED);},_isSearchPanelOpen:function(){return(this._searchPanel.state=="open");},_closeSearchPanel:function(){this._searchPanel.hidePopup();},_openSearchPanel:function(){let searchBoxCount=this._searchPanel.firstChild.childNodes.length;if(""!=this._searchTextbox.value&&0<searchBoxCount){let searchContainer=document.getElementById("gs-ebay-search-container");let searchContainerWidth=searchContainer.boxObject.width;this._searchPanel.style.width=searchContainerWidth+"px";this._searchPanel.firstChild.selectedIndex=-1;this._searchPanel.openPopup(searchContainer,"after_start");}},_clearResultItems:function(){let box=this._searchPanel.firstChild;for(let i=box.itemCount;i>=0;i--){box.removeItemAt(i);}},_selectNextResultItem:function(){let box=this._searchPanel.firstChild;let itemCount=box.itemCount;let selectedIndex=box.selectedIndex;let nextIndex=null;let targetElement;if(itemCount==0){box.selectedIndex=-1;}else if(selectedIndex==(itemCount-1)){nextIndex=0;targetElement=box.getItemAtIndex(nextIndex);if(targetElement.nodeName=="menuseparator"){nextIndex=1;}}else{nextIndex=(selectedIndex+1);targetElement=box.getItemAtIndex(nextIndex);if(targetElement.nodeName=="menuseparator"){nextIndex=(selectedIndex+2);}}
if(nextIndex){box.selectedIndex=nextIndex;box.ensureIndexIsVisible(nextIndex);}},_selectPreviousResultItem:function(){let box=this._searchPanel.firstChild;let selectedIndex=box.selectedIndex;let itemCount=box.itemCount;let previousIndex=null;let targetElement;if(box.itemCount==0){box.selectedIndex=-1;}else if(selectedIndex==0||selectedIndex==-1){previousIndex=(itemCount-1);}else if(selectedIndex==1){targetElement=box.getItemAtIndex(0);if(targetElement.nodeName=="menuseparator"){previousIndex=(itemCount-1);}}else{previousIndex=(selectedIndex-1);targetElement=box.getItemAtIndex(previousIndex);if(targetElement.nodeName=="menuseparator"){previousIndex=(selectedIndex-2);}}
if(previousIndex){box.selectedIndex=previousIndex;box.ensureIndexIsVisible(previousIndex);}},_fillSearchPanel:function(aQuery){if(aQuery&&aQuery.length){this._searchQuery=aQuery;AutocompleteService.search(aQuery);}},handleResultMouseOver:function(aEvent){let item=aEvent.target;while(item&&item.localName!="richlistitem"){item=item.parent;}
if(item){let box=this._searchPanel.firstChild;box.selectedItem=item;}},handleResultSelected:function(aEvent){let selectedItem=this._searchPanel.firstChild.selectedItem;if((aEvent.target.localName!="richlistbox")&&selectedItem){let itemStyle=selectedItem.getAttribute("itemStyle");let itemTitle=selectedItem.getAttribute("title");this._searchTextbox.value=itemTitle;if("popular-product"==itemStyle){let queryArgs={itemId:selectedItem.getAttribute("itemId")};let url=EbayCompanion.Constants.getUrl("searchSuggestion","catalog",queryArgs);EbayCompanion.openPage(aEvent,'searchSuggestion','catalog',queryArgs);}else{let queryArgs={query:itemTitle};EbayCompanion.openPage(aEvent,'searchBox','search',queryArgs);AutocompleteService.storeSearch(itemTitle);}
this._closeSearchPanel();}else{let length=this._searchTextbox.value.length;this._searchTextbox.focus();this._searchTextbox.setSelectionRange(length,length);}},loadSearchPage:function(aEvent){let searchTerm=this._searchTextbox.value;if(""!=searchTerm){let queryArgs={query:searchTerm};EbayCompanion.openPage(aEvent,'searchBox','search',queryArgs);AutocompleteService.storeSearch(searchTerm);this._closeSearchPanel();}},handleSearchTextInput:function(aEvent){let query=this._searchTextbox.value;query=query.replace(/^\s+|\s+$/g,'');if(this._searchTimer){clearTimeout(this._searchTimer);}
if(""==query){this._closeSearchPanel();this._clearResultItems();}else{let that=this;this._searchTimer=window.setTimeout(function(){that._fillSearchPanel(query);},this._searchTextbox.getAttribute("timeout"));}},handleSearchTextKeyPress:function(aEvent){switch(aEvent.keyCode){case KeyEvent.DOM_VK_TAB:if(this._isSearchPanelOpen()){this._selectNextResultItem();aEvent.stopPropagation();aEvent.preventDefault();}
break;case KeyEvent.DOM_VK_DOWN:if(this._isSearchPanelOpen()){this._selectNextResultItem();aEvent.stopPropagation();aEvent.preventDefault();}else{this._openSearchPanel();}
break;case KeyEvent.DOM_VK_UP:if(this._isSearchPanelOpen()){this._selectPreviousResultItem();aEvent.stopPropagation();aEvent.preventDefault();}else{this._openSearchPanel();}
break;case KeyEvent.DOM_VK_ENTER:case KeyEvent.DOM_VK_RETURN:if(this._isSearchPanelOpen()&&this._searchPanel.firstChild.selectedIndex>-1){this.handleResultSelected(aEvent);aEvent.stopPropagation();aEvent.preventDefault();}else{this.loadSearchPage(aEvent);this._closeSearchPanel();}
break;case KeyEvent.DOM_VK_ESCAPE:this._searchTextbox.value="";this._closeSearchPanel();this._clearResultItems();break;}},_showResultItems:function(aResults,aQuery){if(this._searchQuery==aQuery){let box=this._searchPanel.firstChild;let resultCount=aResults.length;let result=null;let item=null;let firstHistoryRecord=true;let firstSuggestion=true;let firstProduct=true;let hideProducts;this._clearResultItems();for(let i=0;i<resultCount;i++){hideProducts=true;result=aResults[i];if("Suggestion"==result.type){if(firstSuggestion){firstSuggestion=false;item=document.createElement("menuseparator");item.setAttribute("type","gs-ebay-search-popup-separator");item.setAttribute("value",EbayCompanion.Constants.stringBundle.getString("ecSidebar.search.popup.suggestions.label"));box.appendChild(item);}
if("popular-product"==result.style){hideProducts=false;if(firstProduct){firstProduct=false;item=document.createElement("menuseparator");item.setAttribute("type","gs-ebay-search-popup-separator");item.setAttribute("value",EbayCompanion.Constants.stringBundle.getString("ecSidebar.search.popup.products.label"));box.appendChild(item);}}}else{if(firstHistoryRecord){firstHistoryRecord=false;item=document.createElement("menuseparator");item.setAttribute("type","gs-ebay-search-popup-separator");item.setAttribute("value",EbayCompanion.Constants.stringBundle.getString("ecSidebar.search.popup.history.label"));box.appendChild(item);}}
item=document.createElement("richlistitem");item.setAttribute("type","gs-ebay-search-result-item");item.setAttribute("class","gs-ebay-search-result-item");item.setAttribute("query",aQuery);item.setAttribute("title",result.title);item.setAttribute("tooltiptext",result.title);item.setAttribute("hideProducts",hideProducts);item.setAttribute("image",result.image);item.setAttribute("itemId",result.id);item.setAttribute("itemStyle",result.style);box.appendChild(item);}
if(0<resultCount){if(!this._isSearchPanelOpen()){this._openSearchPanel();}}else{this._closeSearchPanel();}}},clearSearchHistory:function(){AutocompleteService.clearSearchHistory();},observe:function(aSubject,aTopic,aData){if(AutocompleteService.TOPIC_RESULTS_RETURNED==aTopic){this._showResultItems(aSubject.wrappedJSObject,aData);}}};window.addEventListener("load",function(){Sidebar.SearchManager.init();},false);window.addEventListener("unload",function(){Sidebar.SearchManager.uninit();},false);