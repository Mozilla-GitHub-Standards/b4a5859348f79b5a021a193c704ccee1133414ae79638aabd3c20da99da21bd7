/* Copyright (C) 2007-2011 eBay Inc. All Rights Reserved. */var EXPORTED_SYMBOLS=["DealsApi"];const Cc=Components.classes;const Ci=Components.interfaces;const Cu=Components.utils;const API_URL="http://anywhere.ebay.com/services/feed/deals/?version=3&dealdetail=2&type=0";DealsApi={_appName:null,init:function(){Cu.import("resource://ebaycompanion/constants.js");Cu.import("resource://ebaycompanion/datasource.js");Cu.import("resource://ebaycompanion/helpers/logger.js");Cu.import("resource://ebaycompanion/objects/deal.js");},_extractResponse:function(aResponseText){let xmlResponse=null;aResponseText=aResponseText.replace(/<\?xml .*?>/,"");aResponseText=aResponseText.replace(/xmlns:xsi=["'].*?["']/,"");aResponseText=aResponseText.replace(/xmlns=["'].*?["']/,"");aResponseText=aResponseText.replace(/xsi:schemaLocation=["'].*?["']/,"");xmlResponse=XML(aResponseText);return xmlResponse;},getDailyDeals:function(aCallback){let that=this;let callback=function(aRequest){if(aRequest){let xmlTree=that._extractResponse(aRequest.responseText);let ack=xmlTree..Ack.text();if("Success"==ack){let dealsList=xmlTree..InitiativeSection[0];let dealsArray=that._buildDealsArray(dealsList);aCallback(dealsArray);}else{let message=xmlTree..Errors.LongMessage.text();Logger.error("getDailyDeals: "+ack+": "+message);}}};this._sendRequest(callback);},_buildDealsArray:function(aDealsListNode){let xmlItems=aDealsListNode..Item;let dealsArray=new Array();const LIMIT=4;let xmlItem;for(let i=0;i<xmlItems.length()&&i<LIMIT;i++){xmlItem=xmlItems[i];let itemId=xmlItem.@ItemID;let deal=this._populateFromXML(xmlItem);dealsArray.push(deal);}
return dealsArray;},_populateFromXML:function(aXMLNode){let itemId=Number(aXMLNode.@ItemID);let deal=new Deal(itemId);deal.fromXMLNode(aXMLNode);return deal;},_sendRequest:function(aCallback){let request=Cc["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Ci.nsIXMLHttpRequest);try{let url=API_URL;let siteId=Constants.siteIdForSite(Datasource.homeSite());url+="&siteid="+siteId;request.mozBackgroundRequest=true;request.open("GET",url,true);request.onreadystatechange=function(){if(4!=request.readyState){return;}
aCallback(request);};request.send(null);}catch(e){Logger.error(e);}},generateSystemMessageNotification:function(aSystemMessage){if(typeof(Notification)=="undefined"){Cu.import("resource://ebaycompanion/objects/notification.js");}
if(typeof(InformationNotificationHelper)=="undefined"){Cu.import("resource://ebaycompanion/helpers/informationNotificationHelper.js");}
try{let jsonBody=aSystemMessage.get("jsonBody");let json=Cc["@mozilla.org/dom/json;1"].createInstance(Ci.nsIJSON);let messageObject=json.decode(jsonBody);let messageFormat="[1 body]";let messageContent=messageFormat.replace("body",messageObject.message);let notification=new Notification(aSystemMessage.get("messageId"));notification.addLinkCallback(0,function(aEvent){let windowMediator=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);let mostRecentWindow=windowMediator.getMostRecentWindow("navigator:browser");let roveredUrl=Constants.roverUrl(messageObject.url,Datasource.homeSite(),"platformNotification");mostRecentWindow.EbayCompanion.openRawURL(roveredUrl,aEvent);InformationNotificationHelper.dismissNotification(aSystemMessage.get("messageId"));});notification.set("content",messageContent);notification.set("imageURL",messageObject.icon);notification.set("bgColor",messageObject.bgColor);notification.set("priority",1);InformationNotificationHelper.queueNotification(notification,true);}catch(e){Logger.exception(e);}}};(function(){this.init();}).apply(DealsApi);