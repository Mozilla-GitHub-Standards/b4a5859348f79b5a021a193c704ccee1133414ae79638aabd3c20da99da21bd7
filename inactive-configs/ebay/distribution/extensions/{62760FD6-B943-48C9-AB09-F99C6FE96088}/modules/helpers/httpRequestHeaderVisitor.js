/* Copyright (C) 2007-2011 eBay Inc. All Rights Reserved. */const EXPORTED_SYMBOLS=["HttpRequestHeaderVisitor"];const Cc=Components.classes;const Ci=Components.interfaces;const Ce=Components.Exception;const Cr=Components.results;const Cu=Components.utils;Cu.import("resource://ebaycompanion/helpers/logger.js");function HttpRequestHeaderVisitor(aHttpChannel){this._httpChannel=aHttpChannel;this._requestHeadersArray=new Array();this._postBody=null;}
HttpRequestHeaderVisitor.prototype={getPostDataExtractor:function(aHttpChannel){try{aHttpChannel.QueryInterface(Ci.nsIUploadChannel);let postStream=aHttpChannel.uploadStream;if(postStream){postStream.QueryInterface(Ci.nsISeekableStream);return new ecPostDataExtractor(postStream);}}catch(ex){Logger.exception("There was an error extracting the POST DATA: "+ex);}
return null;},visitHeader:function(name,value){this._requestHeadersArray[name]=value;},inspectRequest:function(){this._requestHeadersArray={};this._httpChannel.visitRequestHeaders(this);var postDataExtractor=this.getPostDataExtractor(this._httpChannel);if(postDataExtractor){let postBody=postDataExtractor.getPostBody();if(postBody!=null){this._postBody=postBody;}}
return this._requestHeadersArray;},getPostData:function(){return this._postBody;}};function ecPostDataExtractor(aStream){this._stream=aStream;this._scriptableStream=Cc["@mozilla.org/scriptableinputstream;1"].createInstance(Ci.nsIScriptableInputStream);this._scriptableStream.init(this._stream);}
ecPostDataExtractor.prototype={rewind:function(){this._stream.seek(0,0);},getPostBody:function(){let streamLength=this._scriptableStream.available();let postString="";try{for(var i=0;i<streamLength;i++){let character=this._scriptableStream.read(1);character?postString+=character:postString+='\0';}}catch(ex){return""+ex;}finally{this.rewind();}
while(postString.indexOf("\r\n")==(postString.length-2)){postString=postString.substring(0,postString.length-2);}
return postString;}};