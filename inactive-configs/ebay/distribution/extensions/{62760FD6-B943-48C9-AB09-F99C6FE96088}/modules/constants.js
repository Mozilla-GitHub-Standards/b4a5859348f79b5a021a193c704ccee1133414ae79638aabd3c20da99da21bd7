/* Copyright (C) 2007-2011 eBay Inc. All Rights Reserved. */const EXPORTED_SYMBOLS=["Constants"];const Cc=Components.classes;const Ci=Components.interfaces;const Ce=Components.Exception;const Cr=Components.results;const Cu=Components.utils;var Constants={_siteData:{"Australia":{num:15,iso:"AU",cur:"AUD",symb:"$*",dom:"ebay.com.au",rid:"705-51927-19398-0"},"Austria":{num:16,iso:"AT",cur:"EUR",symb:"€*",dom:"ebay.at",rid:"5221-51945-19398-0"},"Belgium_Dutch":{num:123,iso:"BE",cur:"EUR",symb:"€*",dom:"benl.ebay.be",rid:"1553-51946-19398-0"},"Belgium_French":{num:23,iso:"BE",cur:"EUR",symb:"€*",dom:"befr.ebay.be",rid:"1553-51946-19398-0"},"Canada":{num:2,iso:"CA",cur:"CAD",symb:"$*",dom:"ebay.ca",rid:"706-51947-19398-0"},"CanadaFrench":{num:210,iso:"CA",cur:"CAD",symb:"$*",dom:"cafr.ebay.ca",rid:"706-51947-19398-0"},"China":{num:223,iso:"CN",cur:"TWD",symb:"$*",dom:"ebay.com.hk",rid:"4080-71112-19398-2"},"France":{num:71,iso:"FR",cur:"EUR",symb:"€*",dom:"ebay.fr",rid:"709-47295-17703-1"},"Germany":{num:77,iso:"DE",cur:"EUR",symb:"€*",dom:"ebay.de",rid:"707-37276-17702-1"},"HongKong":{num:201,iso:"HK",cur:"HKD",symb:"$*",dom:"ebay.com.hk",rid:"3422-51948-19398-0"},"India":{num:203,iso:"IN",cur:"INR",symb:"Rs *",dom:"ebay.in",rid:"4686-51949-19398-0"},"Ireland":{num:205,iso:"IE",cur:"EUR",symb:"€*",dom:"ebay.ie",rid:"5282-51950-19398-0"},"Italy":{num:101,iso:"IT",cur:"EUR",symb:"€*",dom:"ebay.it",rid:"724-51951-19398-0"},"Malaysia":{num:207,iso:"MY",cur:"MYR",symb:"RM *",dom:"ebay.com.my",rid:"4825-71113-19398-0"},"Netherlands":{num:146,iso:"NL",cur:"EUR",symb:"€*",dom:"ebay.nl",rid:"1346-51952-19398-0"},"Philippines":{num:211,iso:"PH",cur:"PHP",symb:"₱*",dom:"ebay.ph",rid:"4824-71114-19398-0"},"Poland":{num:212,iso:"PL",cur:"PLN",symb:"* zł",dom:"ebay.pl",rid:"4908-51953-19398-0"},"Singapore":{num:216,iso:"SG",cur:"SNG",symb:"S$*",dom:"ebay.com.sg",rid:"3423-51954-19398-0"},"Spain":{num:186,iso:"ES",cur:"EUR",symb:"€*",dom:"ebay.es",rid:"1185-51955-19398-0"},"Switzerland":{num:193,iso:"CH",cur:"CHF",symb:"* Fr",dom:"ebay.ch",rid:"5222-51956-19398-0"},"UK":{num:3,iso:"GB",cur:"GBP",symb:"£*",dom:"ebay.co.uk",rid:"710-47297-17704-0"},"US":{num:0,iso:"US",cur:"USD",symb:"$*",dom:"ebay.com",rid:"711-47294-18009-0"}},_localeSiteDataSelector:{"EN-AU":"Australia","DE-AT":"Austria","NL-BE":"Belgium_Dutch","FR-BE":"Belgium_French","EN-CA":"Canada","FR-CA":"CanadaFrench","ZH-CN":"China","FR":"France","DE":"Germany","HI-IN":"India","GA-IE":"Ireland","IT":"Italy","NL":"Netherlands","PL":"Poland","EN-SG":"Singapore","ES-ES":"Spain","DE-CH":"Switzerland","EN-GB":"UK","EN-US":"US"},_installTrackTags:{"EN-US":"711-47294-18009-1","EN-GB":"710-47297-17704-1","FR":"709-47295-17703-2","DE":"707-37276-17702-0","GA-IE":"5282-51950-19398-3","ZH-TW":"3422-51948-19398-3","ZH-CN":"5222-51956-19398-3","ES-ES":"1185-51955-19398-2","NL":"1346-51952-20245-1","HI-IN":"4686-51949-19398-2","PL":"4908-51953-19398-2"},_urls:{"roverTrack":"http://rover.ebay.com/rover/1/#{ROVID}/4?mfe=#{AREA}&mpre=#{URL}","autosuggest":"http://anywhere.ebay.com/services/suggest/?q=#{QUERY}&s=#{SITE}&v=xml","authAuth":"http://signin.#{DOMAIN}/ws/eBayISAPI.dll?SignIn&runame=#{RUNAME}&sessid=#{SESSID}&ruparams=#{RUPARAMS}","authAuthSandbox":"http://signin.sandbox.#{DOMAIN}/ws/eBayISAPI.dll?SignIn&runame=#{RUNAME}&sessid=#{SESSID}&ruparams=#{RUPARAMS}","homePage":"http://www.#{DOMAIN}","buy":"http://hub.#{DOMAIN}/buy","sell":"http://sell.#{DOMAIN}/sell","myEbay":"http://my.#{DOMAIN}/ws/eBayISAPI.dll?MyeBay","myWorld":"http://myworld.#{DOMAIN}/#{USERID}","community":"http://hub.#{DOMAIN}/community","paypal":"http://www.paypal.com","appFeedback":"http://forums.ebay.com/db1/topic/Ebay-Toolbar/Ebay-Sidebar-For/520122397","myMessages":"http://my.#{DOMAIN}/ws/eBayISAPI.dll?MyeBay&CurrentPage=MyeBayMyMessages","search":"http://shop.#{DOMAIN}/?_nkw=#{QUERY}","listing":"http://cgi.#{DOMAIN}/ws/eBayISAPI.dll?ViewItem&item=#{ITEMID}","catalog":"http://catalog.#{DOMAIN}/?_pid=#{ITEMID}","installTrack":"http://rover.#{DOMAIN}/ar/1/#{TRACKTAG}/4?adtype=0&mpt=#{UNIQUEID}","bid":"http://offer.#{DOMAIN}/ws/eBayISAPI.dll?MakeBid&item=#{ITEMID}","bin":"http://offer.#{DOMAIN}/ws/eBayISAPI.dll?BinConfirm&item=#{ITEMID}","pay":"http://payments.#{DOMAIN}/ws/eBayISAPI.dll?CheckoutProcessor&item=#{ITEMID}","paid":"http://payments.#{DOMAIN}/ws/eBayISAPI.dll?OrderAction&action=2&itemid=#{ITEMID}&pagetype=1883&ru=#{RU}","sent":"http://payments.#{DOMAIN}/ws/eBayISAPI.dll?OrderAction&action=4&itemid=#{ITEMID}&pagetype=1883&ru=#{RU}","feedback":"http://feedback.#{DOMAIN}/ws/eBayISAPI.dll?LeaveFeedback2&item=#{ITEMID}&useridto=#{USERIDTO}&useridfrom=#{USERIDFROM}","relist":"http://cgi.#{DOMAIN}/ws/eBayISAPI.dll?RelistItem&Item=#{ITEMID}","find":"http://search.#{DOMAIN}/search/search.dll?GetResult&sim=y&itemid=#{ITEMID}&query=#{QUERY}","similar":"http://cgi.#{DOMAIN}/ws/eBayISAPI.dll?SellYourItem&item=#{ITEMID}","userFeedback":"http://feedback.#{DOMAIN}/ws/eBayISAPI.dll?ViewFeedback2&userid=#{USERID}","revise":"http://cgi.#{DOMAIN}/ws/eBayISAPI.dll?UserItemVerification&item=#{ITEMID}","promote":"http://cgi.#{DOMAIN}/ws/eBayISAPI.dll?PromoteItem&item=#{ITEMID}","viewOther":"http://cgi.#{DOMAIN}/ws/eBayISAPI.dll?ViewSellersOtherItems&userid=#{USERID}","askQuestion":"http://contact.#{DOMAIN}/ws/eBayISAPI.dll?ShowCoreAskSellerQuestion&redirect=0&SSPageName=PageAskSellerQuestion_VI&requested=#{REQUESTED}&iid=#{IID}","contactBuyer":"http://contact.#{DOMAIN}/ws/eBayISAPI.dll?ReturnUserEmail&redirect=0&SSPageName=PageContactBuyer_VI&iid=#{IID}&requested=#{REQUESTED}","orderDetails":"http://payments.#{DOMAIN}/ws/eBayISAPI.dll?ViewPaymentStatus&ssPageName=STRK:MESOX:VPS&itemid=#{ITEMID}","makeOffer":"http://offer.#{DOMAIN}/ws/eBayISAPI.dll?MakeBestOffer&itemId=#{ITEMID}","reviewOffers":"http://offer.#{DOMAIN}/ws/eBayISAPI.dll?ManageBestOffers&itemId=#{ITEMID}","reviewOffer":"http://offer.#{DOMAIN}/ws/eBayISAPI.dll?ManageBestOffers&itemId=#{ITEMID}","savedSellers":"http://my.#{DOMAIN}/ws/eBayISAPI.dll?MyEbayBeta&Column=Sellers&SavedSellers.Filter=&CurrentPage=MyeBaySavedSellers","merchant":"http://shop.#{DOMAIN}/merchant/#{USERID}","savedSearch":"http://shop.#{DOMAIN}/#{SEARCHQUERY}","savedSearches":"http://my.#{DOMAIN}/ws/eBayISAPI.dll?MyEbay&CurrentPage=MyeBayAllFavorites","viewDeals":"http://#{DEALSDOMAIN}.#{DOMAIN}","firstRun":"http://anywhere.#{DOMAIN}/browser/firefox/welcome","purchaseHistory":"http://offer.#{DOMAIN}/ws/eBayISAPI.dll?ViewBidsLogin&item=#{ITEMID}&guest=1","TERMINATOR":""},_roverNames:{"searchSuggestion":"sidebarSearch","autosuggest":"NOTWRAPPED","connectButton":"sidebarInfo","itemButton":"sidebarpri","itemClick":"sidebar","itemContext":"sidebarContext","postLogin":"NOTWRAPPED","searchBox":"search","sidebarButton":"sidebarInfo","statusbarButton":"menu","toolbarButton":"browserbutton","installTracker":"NOTWRAPPED","desktopShortcut":"desktop","installerShortcut":"desktopInstaller","emptyListText":"sidebarnull","alertContents":"alert","alertButton":"alertpri","sidebarNotification":"message","unwrappedLink":"NOTWRAPPED","favoriteSearchClick":"savedSearch","favoriteSellerClick":"favoriteSeller","dealClick":"deal","firstRun":"NOTWRAPPED","platformNotification":"campaign","TERMINATOR":""},_shortcutParameterRead:false,_init:function(){try{Cu.import("resource://ebaycompanion/helpers/logger.js");Cu.import("resource://ebaycompanion/helpers/preferences.js");Cu.import("resource://ebaycompanion/helpers/stringBundle.js");Cu.import("resource://ebaycompanion/helpers/observers.js");this._rootPrefService=Cc["@mozilla.org/preferences-service;1"].getService(Ci.nsIPrefBranch2);this._prefBranch=new Preferences("extensions.ebaycomp.");this._stringBundle=new StringBundle("chrome://ebaycompanion/locale/strings.properties");let that=this;this._observers=new Observers;this._observers.add(function()that._uninit(),"quit-application-granted");this._webProgressListener=Cc["@mozilla.org/docloaderservice;1"].getService(Ci.nsIWebProgress);this._webProgressListener.addProgressListener(this,Ci.nsIWebProgress.NOTIFY_STATE_ALL);}
catch(e){Logger.exception(e);}},_uninit:function(){try{this._webProgressListener.removeProgressListener(this);this._observers.removeAll();}
catch(e){Logger.exception(e);}},QueryInterface:function(aIID){if(aIID.equals(Ci.nsIWebProgressListener)||aIID.equals(Ci.nsISupportsWeakReference)||aIID.equals(Ci.nsISupports))
return this;throw Components.results.NS_NOINTERFACE;},isAuthAuthURL:function(aURL){const AUTH_AUTH_LOGIN_URL_REGEXP=/^https:\/\/signin(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll\?SignIn/i;const AUTH_AUTH_INTERMEDIATE_URL_REGEXP=/^https:\/\/scgi(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI.dll/i;const AUTH_AUTH_ACCEPT_URL_REGEXP=/^https:\/\/signin(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll\?ThirdPartyAuthSucessFailure\&isAuthSuccessful=true/i;const AUTH_AUTH_CANCEL_URL_REGEXP=/^https:\/\/signin(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll\?ThirdPartyAuthSucessFailure/i;const REGULAR_LOGIN_URL_REGEXP=/^https:\/\/signin(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll\?co_partnerid/i;const ITEM_LISTED_REGEXP=/^http:\/\/cgi\d{0,2}(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll/i;const ITEM_OFFER_PLACED_REGEXP=/^http:\/\/offer(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll\?ManageBestOffers\&itemid=(\d)+\&threadid=(\d)+\&OfferSubmittedPage=true/i;const ITEM_PURCHASED_REGEXP=/^http:\/\/offer(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}\/ws\/eBayISAPI\.dll/i;const EBAY_HOMEPAGE=/^http:\/\/www(\.sandbox)?(\.\w{2,4})?\.ebay(\.\w{2,3}){1,2}/i;try{var result=aURL.match(AUTH_AUTH_LOGIN_URL_REGEXP);if(result!=null){return 0;}
result=aURL.match(AUTH_AUTH_INTERMEDIATE_URL_REGEXP);if(result!=null){return 1;}
result=aURL.match(AUTH_AUTH_ACCEPT_URL_REGEXP);if(result!=null){return 2;}
result=aURL.match(AUTH_AUTH_CANCEL_URL_REGEXP);if(result!=null){return 3;}
result=aURL.match(REGULAR_LOGIN_URL_REGEXP);if(result!=null){return 4;}
result=aURL.match(ITEM_LISTED_REGEXP);if(result!=null){return 5;}
result=aURL.match(ITEM_OFFER_PLACED_REGEXP);if(result!=null){return 8;}
result=aURL.match(ITEM_PURCHASED_REGEXP);if(result!=null){return 6;}
result=aURL.match(EBAY_HOMEPAGE);if(result!=null){return 7;}}catch(e){Logger.error("An error occurred trying to check whether it is an auth & auth url.\n["
+e.name+"] "+e.message);}
return-1;},onStateChange:function(aWebProgress,aRequest,aFlag,aStatus){if(aFlag&Ci.nsIWebProgressListener.STATE_IS_REQUEST){if(aFlag&Ci.nsIWebProgressListener.STATE_STOP){if(aRequest){const ITEM_LISTED_URL=5;try{aRequest.QueryInterface(Ci.nsIChannel);}catch(e){}
try{if(aRequest.URI){let url=aRequest.URI.spec;let resultPageNum=this.isAuthAuthURL(url);switch(resultPageNum){case ITEM_LISTED_URL:if((url.indexOf("fromMakeTrack=true")>-1||url.indexOf("ViewItemMakeTrack")>-1)&&Datasource.activeAccount()){if(typeof(Timer)=="undefined"){Cu.import("resource://ebaycompanion/helpers/timer.js");}
new Timer(function(){let windowMediator=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);let mostRecentWindow=windowMediator.getMostRecentWindow("navigator:browser");mostRecentWindow.EbayCompanion.ApiCoordinator.hardUpdate();},3000,Timer.TYPE_ONE_SHOT);}
break;}}}catch(e){Logger.exception(e);}}}}},onLocationChange:function(aProgress,aRequest,aURI)
{},onProgressChange:function(aWebProgress,aRequest,curSelf,maxSelf,curTot,maxTot){},onStatusChange:function(aWebProgress,aRequest,aStatus,aMessage){},onSecurityChange:function(aWebProgress,aRequest,aState){},get shortcutParameterRead(){return this._shortcutParameterRead;},set shortcutParameterRead(aValue){this._shortcutParameterRead=aValue;},get extensionId(){return"{62760FD6-B943-48C9-AB09-F99C6FE96088}";},get prefBranch(){return this._prefBranch;},get rootPrefService(){return this._rootPrefService;},get stringBundle(){return this._stringBundle;},get installTrackTags(){return this._installTrackTags;},get localeSiteDataSelector(){return this._localeSiteDataSelector;},get isFirefox4(){let isFirefox4=true;if("@mozilla.org/extensions/manager;1"in Cc){isFirefox4=false;}
return isFirefox4;},getUrl:function(sourceAreaName,templateName,args){let templateString=this._urls[templateName];if(!templateString){Logger.error("Bad URL Template name: '"+templateName+"'",Logger.DUMP_STACK);return null;}
if(typeof(Datasource)=="undefined"){Cu.import("resource://ebaycompanion/datasource.js");}
let homeSite=Datasource.homeSite();if(templateName=="firstRun"){let firstRunDomains=["US","UK","Germany","Italy","France","Spain","Netherlands","Poland"];let setDefault=true;for(let i=0;i<firstRunDomains.length;i++){if(homeSite==firstRunDomains[i]){setDefault=false;break;}}
if(setDefault){homeSite=null;}}
if(!homeSite){homeSite="US";}
let template=new UrlTemplate(templateString);let domain=this._siteData[homeSite].dom;let activeAccount=Datasource.activeAccount();if(activeAccount&&activeAccount.get("isSandboxAccount")){domain="sandbox."+domain;}
template.setArg("DOMAIN",domain);if(args){for each(let[arg,value]in Iterator(args)){template.setArg(arg,value);}}
let roverAreaName=this._roverNames[sourceAreaName];if(!roverAreaName){Logger.error("Bad area name: '"+sourceAreaName+"'",Logger.DUMP_STACK);return null;}
let retUrl;if(roverAreaName=="NOTWRAPPED"){retUrl=template.url();}else{retUrl=this.roverUrl(template.url(),homeSite,sourceAreaName);Logger.log("Rovered url: "+retUrl);}
return retUrl;},roverUrl:function(aUrl,aHomeSite,aSourceAreaName){let encodedUrl=encodeURIComponent(aUrl);let roverAreaName=this._roverNames[aSourceAreaName]
let roverTemplate=new UrlTemplate(this._urls["roverTrack"]);let roverId=this._siteData[aHomeSite].rid;let isSanDiskBuild=this.prefBranch.get("SanDiskBuild");if((aSourceAreaName.indexOf("desktopShortcut")!=-1||aSourceAreaName.indexOf("installerShortcut")!=-1)&&isSanDiskBuild){let sanDiskBuildRoverId=Datasource.getClientTrackingCode(aHomeSite,true);if(sanDiskBuildRoverId){roverId=sanDiskBuildRoverId;}}else if(!isSanDiskBuild){let clientRoverId=Datasource.getClientTrackingCode(aHomeSite,true);if(clientRoverId){roverId=clientRoverId;}}
roverTemplate.setArg("ROVID",roverId).setArg("AREA",roverAreaName).setArg("URL",encodedUrl);return roverTemplate.url();},supportedSites:function(){let sites=[];for each(let[site,data]in Iterator(this._siteData)){sites.push(site);}
return sites;},siteIdForSite:function(siteString){let siteData=this._siteData[siteString];if(!siteData){siteData=this._siteData["US"];}
return siteData.num;},currencyIdForSite:function(siteString){let siteData=this._siteData[siteString];if(!siteData){siteData=this._siteData["US"];}
return siteData.cur;},countryIso3166ForSite:function(siteString){let siteData=this._siteData[siteString];if(!siteData){siteData=this._siteData["US"];}
return siteData.iso;},addCurrencySymbol:function(value,currency){if(typeof(Datasource)=="undefined"){Cu.import("resource://ebaycompanion/datasource.js");}
let homeSite=Datasource.homeSite();if(!homeSite){homeSite="US";}
let siteData=this._siteData[homeSite];let nativeCurrency=this.currencyIdForSite(homeSite);let ret;if(currency==nativeCurrency){ret=siteData.symb.replace("*",value);}else{ret=currency+" "+value;}
return ret;},formatNumber:function(aValue,aDecimals){let decimalSeparator=this._stringBundle.getString("ecGlobal.num.format.decimal").replace(/"/g,"");let thousandSeparator=this._stringBundle.getString("ecGlobal.num.format.thousandSep").replace(/"/g,"");let value=aValue.toFixed(aDecimals);let valueString=String(value);let valueInteger=parseInt(value);let valueIntegerString=String(valueInteger);let valueIntegerStringSize=valueIntegerString.length;let valueDecimalIndex=valueString.indexOf(".")+1;let valueDecimalString="";let valueLabel="";if(-1!=valueDecimalIndex){valueDecimalString=valueString.substring(valueDecimalIndex,valueString.length);}
for(let i=valueIntegerStringSize-1;i>=0;i--){valueLabel=valueIntegerString[i]+valueLabel;if((0==(valueIntegerStringSize-i)%3)&&i>0){valueLabel=thousandSeparator+valueLabel;}}
if(0<aDecimals){valueLabel+=decimalSeparator+valueDecimalString;}
return valueLabel;},formatDate:function(aTimestamp,aDateFormat){let dateObject=new Date(Number(aTimestamp));let month=dateObject.getMonth()+1;let dateString="";dateString=aDateFormat.replace("$DD",this.formatTwoDigits(dateObject.getDate()));dateString=dateString.replace("$D",dateObject.getDate());if(0<=dateString.indexOf("$ddd")){let dayString=this._stringBundle.getString("ecFlyout.day."+(dateObject.getDay()+1));dateString=dateString.replace("$ddd",dayString);}
if(0<=dateString.indexOf("$MMM")){let monthString=this._stringBundle.getString("ecFlyout.month."+month);dateString=dateString.replace("$MMM",monthString);}
dateString=dateString.replace("$MM",this.formatTwoDigits(month));if(0<=dateString.indexOf("$YYYY")){dateString=dateString.replace("$YYYY",String(dateObject.getFullYear()));}else{dateString=dateString.replace("$YY",String(dateObject.getFullYear()).substring(2));}
dateString=dateString.replace("$hh",this.formatTwoDigits(dateObject.getHours()));dateString=dateString.replace("$mm",this.formatTwoDigits(dateObject.getMinutes()));dateString=dateString.replace("$ss",this.formatTwoDigits(dateObject.getSeconds()));return dateString;},formatTwoDigits:function(aNumber){let formattedNumber="";if(aNumber>=0&&aNumber<100){if(aNumber<10){formattedNumber+="0";}
formattedNumber+=aNumber;}
return formattedNumber;},getRuname:function(useSandbox,siteString){let runame;if(!useSandbox){switch(siteString){case"US":runame="eBay_EU_MicroPr-eBayEUMi-98ba-4-dllhxv";break;default:runame="eBay_EU_MicroPr-EBAYEUMICRI236G-hutwe";break;}}else{switch(siteString){case"US":runame="Glaxstar-GLAXSTARQ7HD16H-rtvtle";break;default:runame="Glaxstar-GLAXSTARR2F4A7D-hgiiki";break;}}
return runame;},getVersion:function(callback){let addonId=this.extensionId;if("@mozilla.org/extensions/manager;1"in Cc){let version=Cc["@mozilla.org/extensions/manager;1"]
.getService(Ci.nsIExtensionManager)
.getItemForID(addonId).version;callback(version);}else{Cu.import("resource://gre/modules/AddonManager.jsm");AddonManager.getAddonByID(addonId,function(addon){callback(addon.version);});}},getOperatingSystem:function(){const RE_OS_WINDOWS=/^Win/i;const RE_OS_MAC=/^Mac/i;const RE_OS_LINUX=/^Linux/i;const RE_OS_WINDOWS_VISTA=/Windows NT 6.0/i;const RE_OS_WINDOWS_WIN7=/Windows NT 6.1/i;let operatingSystem="OTHER";if(null==this._os){let appShellService=Cc["@mozilla.org/appshell/appShellService;1"].getService(Ci.nsIAppShellService);let platform=appShellService.hiddenDOMWindow.navigator.platform;if(platform.match(RE_OS_MAC)){operatingSystem="MAC";}else if(platform.match(RE_OS_WINDOWS)){let userAgent=appShellService.hiddenDOMWindow.navigator.userAgent;if(userAgent.match(RE_OS_WINDOWS_VISTA)){operatingSystem="VISTA";}else if(userAgent.match(RE_OS_WINDOWS_WIN7)){operatingSystem="WIN7";}else{operatingSystem="WINDOWS";}}else if(platform.match(RE_OS_LINUX)){operatingSystem="LINUX";}else{operatingSystem="OTHER";}
this._os=operatingSystem;}else{operatingSystem=this._os;}
return operatingSystem;},getDefaultsFolder:function(aExtensionID){let directoryService=Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties);let defaultsFolder=directoryService.get("ProfD",Ci.nsIFile);defaultsFolder.append("extensions");defaultsFolder.append(aExtensionID);defaultsFolder.append("defaults");return defaultsFolder;},extractFileFromZip:function(aFileName,aFileNameTo){let directoryService=Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties);let zipFile=directoryService.get("ProfD",Ci.nsIFile);let result=false;zipFile.append("extensions");zipFile.append(this.extensionId+".xpi");if(zipFile.exists()){let zipReader=Cc["@mozilla.org/libjar/zip-reader;1"].getService(Ci.nsIZipReader);let fileTo=directoryService.get("ProfD",Ci.nsIFile);let filePath="defaults/"+aFileName;zipReader.open(zipFile);zipReader.test(null);fileTo.append("eBay Inc");fileTo.append(aFileNameTo);if(!fileTo.exists()){fileTo.create(Ci.nsIFile.NORMAL_FILE_TYPE,0777);if(zipReader.hasEntry(filePath)){zipReader.extract(filePath,fileTo);}}
zipReader.close();result=true;}
return result;},generateUUID:function(){Logger.log("generateUUID");var uuidGenerator=Cc["@mozilla.org/uuid-generator;1"].getService(Ci.nsIUUIDGenerator);var uuid=uuidGenerator.generateUUID().toString();if(uuid.indexOf("{")==0){uuid=uuid.substring(1,(uuid.length-1));}
return uuid;},parseMarkupString:function(aString){let content="";try{let text=aString;let element;while(text.length>0){if(text.charAt(0)=="["){element="<a class='notificationLinkText' order='%1'>%2</a>";let endIndex=text.indexOf("]");let left=text.slice(0,endIndex+1);left=left.replace("\n","");let linkRe=/\[(\d+) (.*?)\]/g;linkRe.lastIndex=0;let results=linkRe.exec(left);let index=results[1];element=element.replace("%1",results[1]).replace("%2",results[2]);text=text.slice(endIndex+1);}else{let endIndex=text.indexOf("[");if(endIndex==-1){endIndex=text.length;}
element=text.slice(0,endIndex);text=text.slice(endIndex);}
content=content+element;}}catch(e){Logger.exception(e);}
return content;},timeLeftAsString:function(aTimeLeft){let acc=aTimeLeft/(1000*60*60*24);let days=Math.floor(acc);let leftover=acc-days;acc=leftover*24;let hours=Math.floor(acc);leftover=acc-hours;acc=leftover*60;let minutes=Math.floor(acc);leftover=acc-minutes;acc=leftover*60;let seconds=Math.floor(acc);let vals=[days,hours,minutes,seconds];let units=["day","hour","min","sec"];let skip=0;while(vals[skip]==0){skip++;}
skip=Math.min(vals.length-1,skip);let numValsToUse=2;let params=[];let end=Math.min(skip+numValsToUse,vals.length);for(let i=skip;i<end;i++){let propName="ecItem.timeleft."+units[i]+".abbv";let text=this._stringBundle.getString(propName,[vals[i]]);params.push(text);}
let separator=this._stringBundle.getString("ecItem.timeleft.separator").replace(/"/g,"");let timeLeftString=params.join(separator);return timeLeftString;},getUTF8:function(aString){let utf8;try{utf8=decodeURIComponent(escape(aString));}catch(e){utf8=decodeURIComponent(encodeURIComponent(aString));}
return utf8;},dateFromIso8601:function(time){const dateRe=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})\.(\d{3})Z$/;let results=dateRe.exec(time);if(!results){Logger.error("Incompatible date format: "+time,Logger.DUMP_STACK);return Date();}
let date=new Date();date.setUTCFullYear(results[1],results[2]-1,results[3]);date.setUTCHours(results[4],results[5],results[6],results[7]);return date;},timeDifference:function(aTimestampOne,aTimestampTwo){var startTime,endTime;if(aTimestampOne>aTimestampTwo){startTime=aTimestampTwo;endTime=aTimestampOne;}
else{startTime=aTimestampOne;endTime=aTimestampTwo;}
var timeInSeconds=(endTime-startTime)/1000;var difference={};difference.seconds=parseInt((timeInSeconds)%60);difference.minutes=parseInt((timeInSeconds/60)%60);difference.hours=parseInt((timeInSeconds/3600)%24);difference.days=parseInt((timeInSeconds/86400));return difference;}};function UrlTemplate(url){this._url=url;}
UrlTemplate.prototype={url:function(){if(this.requiredArgs().length>0){Logger.warning("Returning UrlTemplate with unresolved placeholders:")
Logger.warning(this._url,Logger.DUMP_STACK);}
return this._url;},requiredArgs:function(){let argsRE=/#{(.*?)}/g;let result;let args=[];while(result=argsRE.exec(this._url)){args.push(result[1]);}
return args;},setArg:function(arg,value){if(typeof(value)=="undefined"||value==null){Logger.warning("Undefined value passed for placeholder '"+arg+"'.",Logger.DUMP_STACK);value="";}
let argRE=new RegExp("#{"+arg+"}","gi");this._url=this._url.replace(argRE,value);return this;}};Constants._init();